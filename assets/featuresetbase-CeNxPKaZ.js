import{bc as Ee,r as H,m as Q,pF as Ce,a as ve,aO as Ze,g6 as ke,g5 as Pe,al as je,pG as Re,p as Ue,pH as q,aC as Me,pI as Ae,ij as R,aL as Oe,im as A,aj as ge,l2 as ze,d_ as Ve,hG as Se,aI as j,pJ as He,A as We}from"./index-Cd1DZZ4l.js";import{u as N,K as Ge,M as ae,B as L,C as U,y as E,aq as _e,$ as he,J as Ie,ak as Fe,Q as Z,Z as _,H as K,X as Be,g as G,G as Je,b as B,D as Qe,ar as $e,as as Y,a0 as re}from"./arcade-DTU8c0-N.js";import{a as p,r as y}from"./unitConversion-e78s9SmI.js";import{R as qe,q as be,p as Ke,c as se,e as Ye,a as Xe,b as et,N as ee,j as tt,F as nt,E as it,L as W,B as at,d as X,f as P,k as oe}from"./featureSetUtils-DQo7WMw5.js";import{l as rt}from"./portalUtils-GnSXLumU.js";import{u as st,O as Te}from"./SpatialFilter-BKCIc0y5.js";import{x as De,s as le}from"./shared-CFmJHgce.js";import{D as T}from"./WhereClause-CkcH3tJp.js";import"./number-DdjAjrkY.js";import"./hash-CcEbRgUF.js";import"./operatorsWorkerConnection-CIZgOY8L.js";let te=class extends Ee{constructor(t){super(t),this.associations=[]}};H([Q({type:[Ce],json:{write:!0}})],te.prototype,"associations",void 0),te=H([ve("esri.rest.networks.support.QueryAssociationsResult")],te);const ot=te;function lt(i){const{returnDeletes:t,elements:a,gdbVersion:w,moment:g}=i.toJSON();return{returnDeletes:t,elements:JSON.stringify(a.map(e=>({globalId:e.globalId,networkSourceId:e.networkSourceId,terminalId:e.terminalId}))),types:JSON.stringify(i.types.map(e=>q.toJSON(e))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:w,moment:g}}async function ut(i,t,a){const w=Ze(i),g={...lt(t),f:"json"},e=ke({...w.query,...g}),n=Pe(e,{...a,method:"post"}),s=`${w.path}/associations/query`,{data:l}=await je(s,n),c=ot.fromJSON(l);return t.types.includes("connectivity")&&Re(Ue.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-rest-networks-support-QueryAssociationsParameters.html#types",version:"4.29",warnOnce:!0}),c}var de;let V=de=class extends Ee{static from(i){return Me(de,i)}constructor(i){super(i),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};H([Q({type:Boolean,json:{write:!0}})],V.prototype,"returnDeletes",void 0),H([Q({type:[Ae],json:{write:!0}})],V.prototype,"elements",void 0),H([Q({type:[q.apiValues],json:{type:q.jsonValues,read:q.read,write:q.write}})],V.prototype,"types",void 0),H([Q({type:String,json:{write:!0}})],V.prototype,"gdbVersion",void 0),H([Q({type:Date,json:{type:Number,write:{writer:(i,t)=>{t.moment=i==null?void 0:i.getTime()}}}})],V.prototype,"moment",void 0),V=de=H([ve("esri.rest.networks.support.QueryAssociationsParameters")],V);const dt=V;function ft(i){if(i.length===1){if(A(i[0]))return re("distinct",i[0],-1);if(G(i[0]))return re("distinct",i[0].toArray(),-1)}return re("distinct",i,-1)}function ue(i,t,a){const w=i.getVariables();if(w.length>0){const g={};for(const e of w)g[e]=t.evaluateIdentifier(a,{name:e});i.parameters=g}return i}function f(i,t,a=null){for(const w in i)if(w.toLowerCase()===t.toLowerCase())return i[w];return a}function xe(i){if(i===null)return null;const t={type:f(i,"type",""),name:f(i,"name","")};if(t.type==="range")t.range=f(i,"range",[]);else{t.codedValues=[];for(const a of f(i,"codedValues",[]))t.codedValues.push({name:f(a,"name",""),code:f(a,"code",null)})}return t}function fe(i){if(i===null)return null;const t={},a=f(i,"wkt");a!==null&&(t.wkt=a);const w=f(i,"wkid");return w!==null&&(t.wkid=w),t}function Ne(i){if(i===null)return null;const t={hasZ:f(i,"hasz",!1),hasM:f(i,"hasm",!1)},a=f(i,"spatialreference");a!=null&&(t.spatialReference=fe(a));const w=f(i,"x",null);if(w!==null)return t.x=w,t.y=f(i,"y",null),t.hasZ&&(t.z=f(i,"z",null)),t.hasM&&(t.m=f(i,"m",null)),t;const g=f(i,"rings",null);if(g!==null)return t.rings=g,t;const e=f(i,"paths",null);if(e!==null)return t.paths=e,t;const n=f(i,"points",null);if(n!==null)return t.points=n,t;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const l=f(i,s,null);l!==null&&(t[s]=l)}return t}function ct(i,t){for(const a of t)if(a===i)return!0;return!1}function mt(i){return!!i.layerDefinition&&!!i.featureSet&&ct(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(i.layerDefinition.fields)!==!1&&A(i.featureSet.features)!==!1}function J(i){return(i==null?void 0:i.toLowerCase())==="utc"?"UTC":(i==null?void 0:i.toLowerCase())==="unknown"?"Unknown":i}async function pt(i,t,a,w,g,e,n){var m,D,I;const s=await i.getFeatureSetInfo();if(((s==null?void 0:s.layerId)??null)===null||!g.layerIdLookup.get(s.layerId))return null;const l=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),c=[];switch(a){case"connected":c.push("connectivity"),c.push("junction-edge-from-connectivity"),c.push("junction-edge-to-connectivity"),c.push("junction-edge-midspan-connectivity"),c.push("junction-junction-connectivity");break;case"container":case"content":c.push("containment");break;case"structure":case"attached":c.push("attachment");break;case"junctionedge":c.push("junction-edge-from-connectivity"),c.push("junction-edge-to-connectivity");break;case"midspan":c.push("junction-edge-midspan-connectivity");break;default:throw new p(e,y.InvalidParameter,n)}let u=null,o=!1;if(w!==null&&w!==""&&w!==void 0){for(const h of g.terminals)h.terminalName===w&&(u=h.terminalId);u===null&&(o=!0)}const r=[];if(!o){const h=new Ae({globalId:t.field(i.globalIdField),networkSourceId:g.layerIdLookup.get(s.layerId).sourceId,...u?{terminalId:u}:""}),x=await ut(l,new dt({types:c,elements:[h]}));let $=0;for(const v of x.associations){let k=null,M="",S="";if(((m=v.fromNetworkElement)==null?void 0:m.globalId)===h.globalId?(k=v.toNetworkElement,S="to"):((D=v.toNetworkElement)==null?void 0:D.globalId)===h.globalId&&(k=v.fromNetworkElement,S="from"),!k)continue;switch(a){case"attached":if(v.associationType!=="attachment"||S!=="to")continue;break;case"structure":if(v.associationType!=="attachment"||S!=="from")continue;break;case"container":if(v.associationType!=="containment"||S!=="from")continue;break;case"content":if(v.associationType!=="containment"||S!=="to")continue;break;case"connected":break;case"junctionedge":v.associationType==="junction-edge-to-connectivity"?M="to":v.associationType==="junction-edge-from-connectivity"&&(M="from");break;case"midspan":if(v.associationType!=="junction-edge-midspan-connectivity")continue}const ne=((I=g.sourceIdLookup.get(k.networkSourceId))==null?void 0:I.className)??"";r.push(new We({geometry:null,attributes:{objectId:$++,globalId:k.globalId,percentAlong:v.percentAlong??0,isContentVisible:v.isContentVisible?0:1,className:ne,side:M}}))}}const d=new Se({source:r,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new j({name:"objectId",alias:"objectId",type:"oid"}),new j({name:"globalId",alias:"globalId",type:"global-id"}),new j({name:"percentAlong",alias:"percentAlong",type:"double"}),new j({name:"side",alias:"side",type:"string"}),new j({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new j({name:"className",alias:"className",type:"string"})]});return ee(d)}function vt(i){i.mode==="async"&&(i.functions.timezone=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{var l,c;if(N(e,1,2,t,a),Ge(e[0])||ae(e[0]))return"Unknown";if(L(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?J("unknown"):J(e[0].dateFieldsTimeZone);if(!(e[1]instanceof U)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,a);const u=e[1].field("type");if(R(u)===!1)throw new p(t,y.InvalidParameter,a);switch(E(u).toLowerCase()){case"preferredtimezone":return J(e[0].preferredTimeZone);case"editfieldsinfo":return J(((l=e[0].editFieldsInfo)==null?void 0:l.timeZone)??null);case"timeinfo":return J(((c=e[0].timeInfo)==null?void 0:c.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&R(e[1].field("fieldname")))return J(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,a)}const n=_e(e[0],he(t));if(n===null)return null;const s=n.timeZone;return s==="system"?Oe.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},i.functions.sqltimestamp=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{N(e,1,3,t,a);const n=e[0];if(Ie(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,a)}if(ae(n))return n.toSQLWithKeyword();if(L(n)){if(e.length!==3)throw new p(t,y.InvalidParameter,a);await n.load();const s=E(e[1]);if(ae(e[2]))return e[2].toSQLWithKeyword();if(Ie(e[2])===!1)throw new p(t,y.InvalidParameter,a);const l=n.fieldTimeZone(s);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,a){return i.standardFunctionAsync(t,a,(w,g,e)=>{if(N(e,2,4,t,a),Fe(e[0])){const n=E(e[1]);let s=Z(e[2],null);const l=_(Z(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new p(t,y.InvalidParameter,a);return e[0].featureSetById(n,l,s)}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"featuresetbyid",min:2,max:4}),i.functions.getfeatureset=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,1,2,t,a),K(e[0])){let n=Z(e[1],"datasource");return n===null&&(n="datasource"),n=E(n).toLowerCase(),qe(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference??null)}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,a){return i.standardFunctionAsync(t,a,(w,g,e)=>{var u,o;if(N(e,2,5,t,a),e[0]===null)throw new p(t,y.PortalRequired,a);if(e[0]instanceof Be){const r=E(e[1]),d=E(e[2]);let m=Z(e[3],null);const D=_(Z(e[4],!0));if(m===null&&(m=["*"]),A(m)===!1)throw new p(t,y.InvalidParameter,a);let I;return I=(u=t.services)!=null&&u.portal?t.services.portal:ge.getDefault(),I=rt(e[0],I),be(r,d,t.spatialReference??null,m,D,I,t.lrucache,t.interceptor)}if(R(e[0])===!1)throw new p(t,y.PortalRequired,a);const n=E(e[0]),s=E(e[1]);let l=Z(e[2],null);const c=_(Z(e[3],!0));if(l===null&&(l=["*"]),A(l)===!1)throw new p(t,y.InvalidParameter,a);return be(n,s,t.spatialReference??null,l,c,((o=t.services)==null?void 0:o.portal)??ge.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,a){return i.standardFunctionAsync(t,a,(w,g,e)=>{if(N(e,2,4,t,a),Fe(e[0])){const n=E(e[1]);let s=Z(e[2],null);const l=_(Z(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new p(t,y.InvalidParameter,a);return e[0].featureSetByName(n,l,s)}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,a){return i.standardFunction(t,a,(w,g,e)=>{N(e,1,1,t,a);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(R(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(n.layerDefinition=s.layerDefinition,n.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(n.featureSet.features=s.features,n.featureSet.geometryType=s.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=s.objectIdFieldName??"",n.layerDefinition.typeIdField=s.typeIdFieldName,n.layerDefinition.globalIdField=s.globalIdFieldName,n.layerDefinition.fields=s.fields,s.spatialReference&&(n.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof U))throw new p(t,y.InvalidParameter,a);{const s=JSON.parse(e[0].castToText(!0)),l=f(s,"layerdefinition");if(l!==null){n.layerDefinition.geometryType=f(l,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=f(l,"globalidfield",""),n.layerDefinition.objectIdField=f(l,"objectidfield",""),n.layerDefinition.typeIdField=f(l,"typeidfield",""),n.layerDefinition.hasZ=f(l,"hasz",!1)===!0,n.layerDefinition.hasM=f(l,"hasm",!1)===!0;const c=f(l,"spatialreference");c&&(n.layerDefinition.spatialReference=fe(c));const u=[];for(const r of f(l,"fields",[])){const d={name:f(r,"name",""),alias:f(r,"alias",""),type:f(r,"type",""),nullable:f(r,"nullable",!0),editable:f(r,"editable",!0),length:f(r,"length",null),domain:xe(f(r,"domain"))};u.push(d)}n.layerDefinition.fields=u;const o=f(s,"featureset");if(o){const r={};for(const d of u)r[d.name.toLowerCase()]=d.name;for(const d of f(o,"features",[])){const m={},D=f(d,"attributes",{});for(const I in D)m[r[I.toLowerCase()]]=D[I];n.featureSet.features.push({attributes:m,geometry:Ne(f(d,"geometry"))})}}}else{n.layerDefinition.hasZ=f(s,"hasz",!1)===!0,n.layerDefinition.hasM=f(s,"hasm",!1)===!0,n.layerDefinition.geometryType=f(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=f(s,"objectidfieldname",""),n.layerDefinition.typeIdField=f(s,"typeidfieldname","");const c=f(s,"spatialreference");c&&(n.layerDefinition.spatialReference=fe(c));const u=[],o=f(s,"fields",null);if(!A(o))throw new p(t,y.InvalidParameter,a);for(const m of o){const D={name:f(m,"name",""),alias:f(m,"alias",""),type:f(m,"type",""),nullable:f(m,"nullable",!0),editable:f(m,"editable",!0),length:f(m,"length",null),domain:xe(f(m,"domain"))};u.push(D)}n.layerDefinition.fields=u;const r={};for(const m of u)r[m.name.toLowerCase()]=m.name;let d=f(s,"features",null);if(A(d))for(const m of d){const D={},I=f(m,"attributes",{});for(const h in I)D[r[h.toLowerCase()]]=I[h];n.featureSet.features.push({attributes:D,geometry:Ne(f(m,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(mt(n)===!1)throw new p(t,y.InvalidParameter,a);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),Ke.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,2,2,t,a),A(e[0])||G(e[0])){const n=[];let s,l=e[0];if(l instanceof ze&&(l=l.toArray()),!Je(e[1]))throw new p(t,y.InvalidParameter,a);s=e[1].createFunction(t);for(const c of l){const u=s(c);Ve(u)?await u===!0&&n.push(c):u===!0&&n.push(c)}return n}if(L(e[0])){const n=await e[0].load(),s=T.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),l=s.getVariables();if(l.length>0){const c={};for(const u of l)c[u]=i.evaluateIdentifier(t,{name:u});s.parameters=c}return new se({parentfeatureset:e[0],whereclause:s})}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,2,2,t,a),L(e[0])){const n=new Ye(e[1]);return new Xe({parentfeatureset:e[0],orderbyclause:n})}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,2,2,t,a),L(e[0]))return new et({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return B(e[1])>=e[0].length?e[0].slice():e[0].slice(0,B(e[1]));if(G(e[0]))return B(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,B(e[1]));throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,1,1,t,a),L(e[0])){const n=await e[0].first(w.abortSignal);if(n!==null){const s=Qe.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return s._underlyingGraphic=n,s}return n}return A(e[0])?e[0].length===0?null:e[0][0]:G(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{N(e,1,2,t,a);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof U){if(e[1].hasField("minsize")&&(n.minsize=B(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=_(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=B(e[1].field("maxsize"))),e[1].hasField("types")){const s=$e(e[1].field("types"),!1);s.length>0&&(n.types=s)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,a)}if(K(e[0])){const s=e[0]._layer;let l;if(L(s))l=s;else{if(s==null||!De(s))return[];l=ee(s,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{N(e,2,4,t,a);const n=e[0],s=E(e[1]);let l=Z(e[2],null);const c=_(Z(e[3],!0));if(l===null&&(l=["*"]),A(l)===!1)throw new p(t,y.InvalidParameter,a);if(e[0]===null)return null;if(!K(e[0]))throw new p(t,y.InvalidParameter,a);const u=n._layer;let o;if(L(u))o=u;else{if(u==null||!De(u))return null;o=ee(u,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}o=await o.load();const r=o.relationshipMetaData().filter(h=>h.name===s);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return tt(o,r[0],n.field(o.objectIdField),o.spatialReference,l,c,t.lrucache,t.interceptor);let d=o.serviceUrl();if(!d)return null;d=d.charAt(d.length-1)==="/"?d+r[0].relatedTableId.toString():d+"/"+r[0].relatedTableId.toString();const m=await nt(d,o.spatialReference,l,c,t.lrucache,t.interceptor);await m.load();let D=m.relationshipMetaData();if(D=D.filter(h=>h.id===r[0].id),n.hasField(r[0].keyField)===!1||n.field(r[0].keyField)===null){const h=await o.getFeatureByObjectId(n.field(o.objectIdField),[r[0].keyField]);if(h){const x=T.create(D[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return x.parameters={id:h.attributes[r[0].keyField]},m.filter(x)}return new st({parentfeatureset:m})}const I=T.create(D[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return I.parameters={id:n.field(r[0].keyField)},m.filter(I)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{N(e,2,3,t,a);const n=e[0],s=E(Z(e[1],"")).toLowerCase(),l=R(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!K(e[0]))throw new p(t,y.InvalidParameter,a);let c=n._layer;if(c instanceof Se&&(c=ee(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),c===null||L(c)===!1)return null;await c.load();const u=c.serviceUrl(),o=await it(u,t.spatialReference,!0);if(o.unVersion>=8)return await pt(c,n,s,l,o,t,a);const r=o.associations;let d=null,m=null,D=!1;if(l!==null&&l!==""&&l!==void 0){for(const b of o.terminals)b.terminalName===l&&(m=b.terminalId);m===null&&(D=!0)}const I=r.getFieldsIndex(),h=I.get("TOGLOBALID").name,x=I.get("FROMGLOBALID").name,$=I.get("TOTERMINALID").name,v=I.get("FROMTERMINALID").name,k=I.get("FROMNETWORKSOURCEID").name,M=I.get("TONETWORKSOURCEID").name,S=I.get("ASSOCIATIONTYPE").name,ne=I.get("ISCONTENTVISIBLE").name,Le=I.get("OBJECTID").name;for(const b of c.fields)if(b.type==="global-id"){d=n.field(b.name);break}let O=null,ce=new W(new j({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),me=new W(new j({name:"side",alias:"side",type:"string"}),T.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const C="globalid",pe="globalId",ye={};for(const b in o.lkp)ye[b]=o.lkp[b].sourceId;const z=new at(new j({name:"classname",alias:"classname",type:"string"}),null,ye);let F="";switch(s){case"midspan":{F=`((${h}='${d}') OR ( ${x}='${d}')) AND (${S} IN (5))`,z.codefield=T.create(`CASE WHEN (${h}='${d}') THEN ${k} ELSE ${M} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const b=le(P.findField(r.fields,x));b.name=C,b.alias=C,O=new W(b,T.create(`CASE WHEN (${x}='${d}') THEN ${h} ELSE ${x} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),ce=o.unVersion>=4?new oe(P.findField(r.fields,I.get("PERCENTALONG").name)):new W(new j({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${h}='${d}') OR ( ${x}='${d}')) AND (${S} IN (4,6))`,z.codefield=T.create(`CASE WHEN (${h}='${d}') THEN ${k} ELSE ${M} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const b=le(P.findField(r.fields,x));b.name=C,b.alias=C,O=new W(b,T.create(`CASE WHEN (${x}='${d}') THEN ${h} ELSE ${x} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),me=new W(new j({name:"side",alias:"side",type:"string"}),T.create(`CASE WHEN (${S}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let b=`${h}='@T'`,we=`${x}='@T'`;m!==null&&(b+=` AND ${$}=@A`,we+=` AND ${v}=@A`),F="(("+b+") OR ("+we+"))",F=Y(F,"@T",d??""),b=Y(b,"@T",d??""),m!==null&&(b=Y(b,"@A",m.toString()),F=Y(F,"@A",m.toString())),z.codefield=T.create("CASE WHEN "+b+` THEN ${k} ELSE ${M} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const ie=le(P.findField(r.fields,x));ie.name=C,ie.alias=C,O=new W(ie,T.create("CASE WHEN "+b+` THEN ${x} ELSE ${h} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${h}='${d}' AND ${S} = 2`,m!==null&&(F+=` AND ${$} = `+m.toString()),z.codefield=k,F="( "+F+" )",O=new X(P.findField(r.fields,x),C,C);break;case"content":F=`(${x}='${d}' AND ${S} = 2)`,m!==null&&(F+=` AND ${v} = `+m.toString()),z.codefield=M,F="( "+F+" )",O=new X(P.findField(r.fields,h),C,C);break;case"structure":F=`(${h}='${d}' AND ${S} = 3)`,m!==null&&(F+=` AND ${$} = `+m.toString()),z.codefield=k,F="( "+F+" )",O=new X(P.findField(r.fields,x),C,pe);break;case"attached":F=`(${x}='${d}' AND ${S} = 3)`,m!==null&&(F+=` AND ${v} = `+m.toString()),z.codefield=M,F="( "+F+" )",O=new X(P.findField(r.fields,h),C,pe);break;default:throw new p(t,y.InvalidParameter,a)}return D&&(F="1 <> 1"),new P({parentfeatureset:r,adaptedFields:[new oe(P.findField(r.fields,Le)),new oe(P.findField(r.fields,ne)),O,me,z,ce],extraFilter:F?T.create(F,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,3,3,t,a),!L(e[0]))throw new p(t,y.InvalidParameter,a);const n=await e[0].load(),s=[],l=[];let c=!1,u=[];if(R(e[1]))u.push(e[1]);else if(e[1]instanceof U)u.push(e[1]);else if(A(e[1]))u=e[1];else{if(!G(e[1]))throw new p(t,y.InvalidParameter,a);u=e[1].toArray()}for(const o of u)if(R(o)){const r=T.create(E(o),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=Te(r)===!0?E(o):"%%%%FIELDNAME";s.push({name:d,expression:r}),d==="%%%%FIELDNAME"&&(c=!0)}else{if(!(o instanceof U))throw new p(t,y.InvalidParameter,a);{const r=o.hasField("name")?o.field("name"):"%%%%FIELDNAME",d=o.hasField("expression")?o.field("expression"):"";if(r==="%%%%FIELDNAME"&&(c=!0),!r)throw new p(t,y.InvalidParameter,a);s.push({name:r,expression:T.create(d||r,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(u=[],R(e[2]))u.push(e[2]);else if(A(e[2]))u=e[2];else if(G(e[2]))u=e[2].toArray();else{if(!(e[2]instanceof U))throw new p(t,y.InvalidParameter,a);u.push(e[2])}for(const o of u){if(!(o instanceof U))throw new p(t,y.InvalidParameter,a);{const r=o.hasField("name")?o.field("name"):"",d=o.hasField("statistic")?o.field("statistic"):"",m=o.hasField("expression")?o.field("expression"):"";if(!r||!d||!m)throw new p(t,y.InvalidParameter,a);l.push({name:r,statistic:d.toLowerCase(),expression:T.create(m,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c){const o={};for(const d of n.fields)o[d.name.toLowerCase()]=1;for(const d of s)d.name!=="%%%%FIELDNAME"&&(o[d.name.toLowerCase()]=1);for(const d of l)d.name!=="%%%%FIELDNAME"&&(o[d.name.toLowerCase()]=1);let r=0;for(const d of s)if(d.name==="%%%%FIELDNAME"){for(;o["field_"+r.toString()]===1;)r++;o["field_"+r.toString()]=1,d.name="FIELD_"+r.toString()}}for(const o of s)ue(o.expression,i,t);for(const o of l)ue(o.expression,i,t);return e[0].groupby(s,l)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(L(e[0])){N(e,2,2,t,a);const n=await e[0].load(),s=[];let l=[];if(R(e[1]))l.push(e[1]);else if(e[1]instanceof U)l.push(e[1]);else if(A(e[1]))l=e[1];else{if(!G(e[1]))throw new p(t,y.InvalidParameter,a);l=e[1].toArray()}let c=!1;for(const u of l)if(R(u)){const o=T.create(E(u),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),r=Te(o)===!0?E(u):"%%%%FIELDNAME";s.push({name:r,expression:o}),r==="%%%%FIELDNAME"&&(c=!0)}else{if(!(u instanceof U))throw new p(t,y.InvalidParameter,a);{const o=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",r=u.hasField("expression")?u.field("expression"):"";if(o==="%%%%FIELDNAME"&&(c=!0),!o)throw new p(t,y.InvalidParameter,a);s.push({name:o,expression:T.create(r||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c){const u={};for(const r of n.fields)u[r.name.toLowerCase()]=1;for(const r of s)r.name!=="%%%%FIELDNAME"&&(u[r.name.toLowerCase()]=1);let o=0;for(const r of s)if(r.name==="%%%%FIELDNAME"){for(;u["field_"+o.toString()]===1;)o++;u["field_"+o.toString()]=1,r.name="FIELD_"+o.toString()}}for(const u of s)ue(u.expression,i,t);return e[0].groupby(s,[])}return ft(e)})},i.functions.getfeaturesetinfo=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,1,1,t,a),!L(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?U.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},he(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,a){return i.standardFunctionAsync(t,a,async(w,g,e)=>{if(N(e,2,2,t,a),L(e[0])){const n=await e[0].load(),s=e[1];if(!He(s))throw new p(t,y.InvalidParameter,a);if(n.subtypeField){const c=T.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new se({parentfeatureset:e[0],whereclause:c})}if(n.typeIdField===null||n.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,a);const l=T.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new se({parentfeatureset:e[0],whereclause:l})}throw new p(t,y.InvalidParameter,a)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{vt as registerFunctions};
