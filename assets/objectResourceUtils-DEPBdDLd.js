const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-DpVmwVm3.js","assets/index-BgufZbH7.js","assets/index-DHNSHnXL.css","assets/resourceUtils-0bSrDEf4.js"])))=>i.map(i=>d[i]);
import{ne as ae,nf as ie,ng as F,jr as K,js as q,nh as le,ni as ue,nj as ce,_ as de,nk as fe,iW as me,dh as pe,c7 as L,he as D,cM as xe,nl as U,cP as he,ca as Te,mt as ge,kt as J,nm as X,c5 as be,mW as P,c8 as W,kQ as ee,nn as A,no as ye,np as we,mY as Re,nq as z,mZ as G,nr as $e,ct as _,kP as ve,b7 as B,co as S,kv as Be,kw as Se,kx as H,ky as Q,kz as Me,ns as Ae,nt as Ee,nu as Y,nv as Oe,nw as _e,cm as Ie,iL as Fe,nx as Le,ny as ke}from"./index-BgufZbH7.js";import{o as Pe,d as Z}from"./vec4-BDH-tU77.js";import{o as Ce,n as je}from"./indexUtils-CZx2V5hZ.js";import{n as k}from"./resourceUtils-0bSrDEf4.js";function M(t){if(t==null)return null;const r=t.offset!=null?t.offset:ae,n=t.rotation!=null?t.rotation:0,s=t.scale!=null?t.scale:ie,c=F(1,0,0,0,1,0,r[0],r[1],1),f=F(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),i=F(s[0],0,0,0,s[1],0,0,0,1),l=K();return q(l,f,i),q(l,c,l),l}class Ne{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Ve{constructor(r,n,s){this.name=r,this.lodThreshold=n,this.pivotOffset=s,this.stageResources=new Ne,this.numberOfVertices=0}}async function qe(t,r){var u;const n=te(le(t));if(n.fileType==="wosr"){const m=await(r.cache?r.cache.loadWOSR(n.url,r):ue(n.url,r)),{engineResources:p,referenceBoundingBox:d}=ce(m,r);return{lods:p,referenceBoundingBox:d,isEsriSymbolResource:!1,isWosr:!0}}let s;if(r.cache)s=await r.cache.loadGLTF(n.url,r,!!r.usePBR);else{const{loadGLTF:m}=await de(()=>import("./loader-DpVmwVm3.js"),__vite__mapDeps([0,1,2,3]));s=await m(new fe(r.streamDataRequester),n.url,r,r.usePBR)}const c=(u=s.model.meta)==null?void 0:u.ESRI_proxyEllipsoid,f=s.meta.isEsriSymbolResource&&c!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";f&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,Ge(s,c));const i=!!r.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:i,isSchematic:!1,treeRendering:f,mrrFactors:Le}:{usePBR:i,isSchematic:!1,treeRendering:!1,mrrFactors:ke},e={...r.materialParameters,treeRendering:f},{engineResources:o,referenceBoundingBox:a}=De(s,l,e,r,n.specifiedLodIndex);return{lods:o,referenceBoundingBox:a,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function te(t){const r=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return r?{fileType:"gltf",url:r[1],specifiedLodIndex:r[4]!=null?Number(r[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function De(t,r,n,s,c){const f=t.model,i=new Array,l=new Map,e=new Map,o=f.lods.length,a=be();return f.lods.forEach((u,m)=>{const p=s.skipHighLods===!0&&(o>1&&m===0||o>3&&m===1)||s.skipHighLods===!1&&c!=null&&m!==c;if(p&&m!==0)return;const d=new Ve(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(T=>{const h=p?new P({},s):Ue(f,T,d,r,n,l,e,s),{geometry:b,vertexCount:y}=We(T,h??new P({},s)),g=b.boundingInfo;g!=null&&m===0&&(W(a,g.bbMin),W(a,g.bbMax)),h!=null&&(d.stageResources.geometries.push(b),d.numberOfVertices+=y)}),p||i.push(d)}),{engineResources:i,referenceBoundingBox:a}}function Ue(t,r,n,s,c,f,i,l){var y,g;const e=t.materials.get(r.material);if(e==null)return null;const{normal:o,color:a,texCoord0:u,tangent:m}=r.attributes,p=r.material+(o?"_normal":"")+(a?"_color":"")+(u?"_texCoord0":"")+(m?"_tangent":""),d=r.attributes.texCoord0!=null,T=r.attributes.normal!=null,h=ze(e.alphaMode);if(!f.has(p)){if(d){const v=(O,oe=!1)=>{if(O!=null&&!i.has(O)){const I=t.textures.get(O);if(I){const w=I.data;i.set(O,new Fe(k(w)?w.data:w,{...I.parameters,preMultiplyAlpha:!k(w)&&oe,encoding:k(w)?w.encoding:void 0}))}}};v(e.colorTexture,h!==A.Opaque),v(e.normalTexture),v(e.occlusionTexture),v(e.emissiveTexture),v(e.metallicRoughnessTexture)}const x=1/ee,$=e.color[0]**x,C=e.color[1]**x,j=e.color[2]**x,re=e.emissiveFactor[0]**x,se=e.emissiveFactor[1]**x,ne=e.emissiveFactor[2]**x,E=e.colorTexture!=null&&d?i.get(e.colorTexture):null,N=ye(e),V=((y=e.normalTextureTransform)==null?void 0:y.scale)!=null?(g=e.normalTextureTransform)==null?void 0:g.scale:we;f.set(p,new P({...s,transparent:h===A.Blend,customDepthTest:$e.Lequal,textureAlphaMode:h,textureAlphaCutoff:e.alphaCutoff,diffuse:[$,C,j],ambient:[$,C,j],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?G.None:G.Back,hasVertexColors:!!r.attributes.color,hasVertexTangents:!!r.attributes.tangent,normalType:T?z.Attribute:z.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:E!=null?E.id:void 0,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&d?i.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:E!=null&&!!E.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&d?i.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&d?i.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&d?i.get(e.metallicRoughnessTexture).id:void 0,emissiveFactor:[re,se,ne],mrrFactors:N?Re:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:N,colorTextureTransformMatrix:M(e.colorTextureTransform),normalTextureTransformMatrix:M(e.normalTextureTransform),scale:[V[0],V[1]],occlusionTextureTransformMatrix:M(e.occlusionTextureTransform),emissiveTextureTransformMatrix:M(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:M(e.metallicRoughnessTextureTransform),...c},l))}const b=f.get(p);if(n.stageResources.materials.push(b),d){const x=$=>{$!=null&&n.stageResources.textures.push(i.get($))};x(e.colorTexture),x(e.normalTexture),x(e.occlusionTexture),x(e.emissiveTexture),x(e.metallicRoughnessTexture)}return b}function We(t,r){const n=t.attributes.position.count,s=Ce(t.indices||n,t.primitiveType),c=_(3*n),{typedBuffer:f,typedBufferStride:i}=t.attributes.position;ve(c,f,t.transform,3,i);const l=[[B.POSITION,new S(c,s,3,!0)]];if(t.attributes.normal!=null){const o=_(3*n),{typedBuffer:a,typedBufferStride:u}=t.attributes.normal;Be(R,t.transform),Se(o,a,R,3,u),H(R)&&Q(o,o),l.push([B.NORMAL,new S(o,s,3,!0)])}if(t.attributes.tangent!=null){const o=_(4*n),{typedBuffer:a,typedBufferStride:u}=t.attributes.tangent;Me(R,t.transform),Pe(o,a,R,4,u),H(R)&&Q(o,o,4),l.push([B.TANGENT,new S(o,s,4,!0)])}if(t.attributes.texCoord0!=null){const o=_(2*n),{typedBuffer:a,typedBufferStride:u}=t.attributes.texCoord0;je(o,a,2,u),l.push([B.UV0,new S(o,s,2,!0)])}const e=t.attributes.color;if(e!=null){const o=new Uint8Array(4*n);e.elementCount===4?e instanceof X?Z(o,e,1,255):(e instanceof Ae||e instanceof Ee)&&Z(o,e,1/255,255):(o.fill(255),e instanceof J?Y(o,e.typedBuffer,1,255,4,e.typedBufferStride):(t.attributes.color instanceof Oe||t.attributes.color instanceof _e)&&Y(o,e.typedBuffer,1/255,255,4,t.attributes.color.typedBufferStride)),l.push([B.COLOR,new S(o,s,4,!0)])}return{geometry:new Ie(r,l),vertexCount:n}}const R=K();function ze(t){switch(t){case"BLEND":return A.Blend;case"MASK":return A.Mask;case"OPAQUE":case null:case void 0:return A.Opaque}}function Ge(t,r){for(let n=0;n<t.model.lods.length;++n){const s=t.model.lods[n];for(const c of s.parts){const f=c.attributes.normal;if(f==null)return;const i=c.attributes.position,l=i.count,e=L(),o=L(),a=L(),u=new Float32Array(4*l),m=new Float32Array(3*l),p=me(pe(),c.transform);let d=0,T=0;for(let h=0;h<l;h++){i.getVec(h,o),f.getVec(h,e),D(o,o,c.transform),xe(a,o,r.center),U(a,a,r.radius);const b=a[2],y=he(a),g=Math.min(.45+.55*y*y,1)**ee;U(a,a,r.radius),p!==null&&D(a,a,p),Te(a,a),n+1!==t.model.lods.length&&t.model.lods.length>1&&ge(a,a,e,b>-1?.2:Math.min(-4*b-3.8,1)),m[d]=a[0],m[d+1]=a[1],m[d+2]=a[2],d+=3,u[T]=g,u[T+1]=g,u[T+2]=g,u[T+3]=1,T+=4}c.attributes.normal=new J(m),c.attributes.color=new X(u)}}}const Ke=Object.freeze(Object.defineProperty({__proto__:null,fetch:qe,parseUrl:te},Symbol.toStringTag,{value:"Module"}));export{qe as Y,Ke as o,M as s};
